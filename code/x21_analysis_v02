# -*- coding: utf-8 -*-
"""
Umfassendes Analyse-Skript zur Auswertung von Supermarktprospekten.

Dieses Skript lädt annotierte Daten aus den Subset-Dateien, bereinigt sie
und führt eine Reihe von Analysen zur Präsenz und zum Kontext von
Alkoholwerbung durch. Die Ergebnisse werden als Konsolenausgaben und
visuell ansprechende Diagramme im 'analyse_ergebnisse'-Ordner gespeichert.

**Version 2.0:** Vereinfacht, um ausschließlich Daten aus den Annotations-
Subsets zu laden, ohne zusätzlichen Merge-Schritt.
"""

import os
import glob
import pandas as pd
import matplotlib

# Weist Matplotlib an, ein nicht-interaktives Backend zu verwenden.
# Dies ist wichtig für die Ausführung auf Servern ohne grafische Oberfläche.
matplotlib.use('Agg')
import matplotlib.pyplot as plt
import seaborn as sns

# --- Globale Konfiguration ---
# Pfade zu den Daten. Passen Sie diese bei Bedarf an.
ANNOTATIONS_DIR = 'annotations_api_gemini_2.0_flash/'
OUTPUT_DIR = 'analyse_ergebnisse_v02/'

# --- Hilfsfunktionen für Plots ---
def annotate_bars(ax, **kwargs):
    """Fügt Datenlabels über die Balken eines Seaborn-Barplots hinzu."""
    for p in ax.patches:
        ax.annotate(f"{p.get_height():.1f}%",
                    (p.get_x() + p.get_width() / 2., p.get_height()),
                    ha='center', va='center',
                    xytext=(0, 9),
                    textcoords='offset points',
                    **kwargs)

# --- Hauptfunktionen ---
def load_data(annotations_dir):
    """
    Lädt alle annotierten CSV-Dateien aus dem angegebenen Verzeichnis
    und führt sie zu einem einzigen DataFrame zusammen.
    """
    if not os.path.exists(annotations_dir):
        print(f"Fehler: Das Annotations-Verzeichnis '{annotations_dir}' wurde nicht gefunden.")
        return None

    csv_files = glob.glob(os.path.join(annotations_dir, '*.csv'))
    if not csv_files:
        print(f"Fehler: Keine CSV-Dateien im Verzeichnis '{annotations_dir}' gefunden.")
        return None

    df_list = [pd.read_csv(file) for file in csv_files]
    combined_df = pd.concat(df_list, ignore_index=True)

    print(f"Daten erfolgreich geladen: {len(combined_df)} Seiten aus {combined_df['original_pdf_path'].nunique()} Prospekten.")
    return combined_df


def preprocess_data(df):
    """
    Bereinigt die Daten, konvertiert Datentypen und fügt nützliche Spalten hinzu.
    """
    # Fehlerhafte (98) oder unklare (99) Werte in numerische NaN umwandeln
    for col in ['prod_pp', 'prod_alc', 'child', 'reduc', 'warning', 'alc', 'product']:
        df[col] = pd.to_numeric(df[col], errors='coerce')
        df[col] = df[col].replace({98: pd.NA, 99: pd.NA})

    # Zeilen mit fehlenden Werten in Kernspalten entfernen
    # Annahme: 'country' und 'supermarket' sind in den CSVs vorhanden.
    df.dropna(subset=['prod_pp', 'prod_alc', 'alc', 'country', 'supermarket'], inplace=True)
    df[['prod_pp', 'prod_alc']] = df[['prod_pp', 'prod_alc']].astype(int)

    # Gesamtseitenzahl pro Prospekt für relative Positionsbestimmung berechnen
    df['total_pages'] = df.groupby('original_pdf_path')['page_number'].transform('max')
    df['relative_page_pos'] = (df['page_number'] / df['total_pages']).round(2)
    
    # Datentypen für Effizienz optimieren
    df['country'] = df['country'].astype('category')
    df['supermarket'] = df['supermarket'].astype('category')

    return df


def generate_visual_report(df):
    """
    Führt alle Analysen durch und generiert hochwertige Diagramme.
    """
    if not os.path.exists(OUTPUT_DIR):
        os.makedirs(OUTPUT_DIR)

    sns.set_theme(style="whitegrid", palette="viridis")
    print("\n--- Starte Erstellung des visuellen Berichts ---")

    # --- 1. Präsenz von Alkoholwerbung nach Land ---
    print("1. Analysiere Präsenz von Alkoholwerbung nach Land...")
    alc_presence = df.groupby('country')['alc'].value_counts(normalize=True).mul(100).rename('percent').reset_index()
    alc_presence = alc_presence[alc_presence['alc'] == 1.0]

    plt.figure(figsize=(12, 7))
    ax = sns.barplot(x='country', y='percent', data=alc_presence.sort_values('percent', ascending=False))
    ax.set_title('Anteil der Prospektseiten mit Alkoholwerbung nach Land', fontsize=16, pad=20)
    ax.set_xlabel('Land', fontsize=12)
    ax.set_ylabel('Anteil in Prozent (%)', fontsize=12)
    annotate_bars(ax)
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, '1_anteil_alkohol_land.png'))
    plt.close()

    # --- 2. Platzierung von Alkoholwerbung im Prospekt ---
    print("2. Analysiere Platzierung von Alkoholwerbung...")
    df_alc = df[df['alc'] == 1.0]
    
    plt.figure(figsize=(12, 7))
    ax = sns.boxplot(x='country', y='relative_page_pos', data=df_alc, showmeans=True)
    ax.set_title('Verteilung von Alkoholwerbung innerhalb der Prospekte (nach Land)', fontsize=16, pad=20)
    ax.set_xlabel('Land', fontsize=12)
    ax.set_ylabel('Relative Seitenposition (0=Anfang, 1=Ende)', fontsize=12)
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, '2_platzierung_alkohol_land_boxplot.png'))
    plt.close()

    # --- 3. Anteil alkoholischer Produkte an Gesamtprodukten ---
    print("3. Analysiere Anteil alkoholischer Produkte...")
    prod_summary = df.groupby('country')[['prod_pp', 'prod_alc']].sum()
    prod_summary['alc_ratio_percent'] = (prod_summary['prod_alc'] / prod_summary['prod_pp']) * 100
    prod_summary.sort_values('alc_ratio_percent', ascending=False, inplace=True)

    plt.figure(figsize=(12, 7))
    ax = sns.barplot(x=prod_summary.index, y='alc_ratio_percent', data=prod_summary)
    ax.set_title('Anteil alkoholischer Produkte an der Gesamtproduktzahl nach Land', fontsize=16, pad=20)
    ax.set_xlabel('Land', fontsize=12)
    ax.set_ylabel('Anteil in Prozent (%)', fontsize=12)
    annotate_bars(ax)
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, '3_anteil_alkoholprodukte_land.png'))
    plt.close()

    # --- 4. Analyse nach Supermarkt (Top 10) ---
    print("4. Analysiere Supermärkte...")
    supermarket_summary = df.groupby('supermarket').agg(
        total_products=('prod_pp', 'sum'),
        alc_products=('prod_alc', 'sum')
    ).reset_index()
    supermarket_summary = supermarket_summary[supermarket_summary['total_products'] > 0]
    supermarket_summary['alc_prod_ratio'] = (supermarket_summary['alc_products'] / supermarket_summary['total_products']) * 100
    top_10_supermarkets = supermarket_summary.sort_values('alc_prod_ratio', ascending=False).head(10)

    plt.figure(figsize=(12, 8))
    ax = sns.barplot(x='alc_prod_ratio', y='supermarket', data=top_10_supermarkets, orient='h', palette='magma')
    ax.set_title('Top 10 Supermärkte nach Anteil alkoholischer Produkte', fontsize=16, pad=20)
    ax.set_xlabel('Anteil alkoholischer Produkte in Prozent (%)', fontsize=12)
    ax.set_ylabel('Supermarkt', fontsize=12)
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, '4_top10_supermaerkte_alkoholanteil.png'))
    plt.close()

    # --- 5. Analyse von Rabattaktionen (Seiten mit vs. ohne Alkohol) ---
    print("5. Analysiere Rabattaktionen...")
    reduc_analysis = df.groupby(['country', 'alc'])['reduc'].value_counts(normalize=True).mul(100).rename('percent').reset_index()
    reduc_analysis = reduc_analysis[reduc_analysis['reduc'] == 1.0] # Nur Seiten mit Rabatt
    reduc_analysis['alc'] = reduc_analysis['alc'].map({0.0: 'Ohne Alkohol', 1.0: 'Mit Alkohol'})

    plt.figure(figsize=(14, 8))
    ax = sns.barplot(x='country', y='percent', hue='alc', data=reduc_analysis, palette='rocket')
    ax.set_title('Anteil der Seiten mit Rabattaktionen (Vergleich)', fontsize=16, pad=20)
    ax.set_xlabel('Land', fontsize=12)
    ax.set_ylabel('Anteil der Seiten mit Rabatten (%)', fontsize=12)
    ax.legend(title='Seitentyp')
    plt.tight_layout()
    plt.savefig(os.path.join(OUTPUT_DIR, '5_rabattaktionen_vergleich.png'))
    plt.close()
    
    # --- 6. Analyse von Warnhinweisen pro Land ---
    print("6. Analysiere Warnhinweise...")
    warning_analysis = df_alc.groupby('country')['warning'].value_counts(normalize=True).mul(100).rename('percent').reset_index()
    warning_analysis = warning_analysis[warning_analysis['warning'] == 1.0] # Nur Seiten mit Warnhinweis
    
    if not warning_analysis.empty:
        plt.figure(figsize=(12, 7))
        ax = sns.barplot(x='country', y='percent', data=warning_analysis.sort_values('percent', ascending=False), palette='cubehelix')
        ax.set_title('Anteil der Alkoholwerbung mit gesetzl. Warnhinweis nach Land', fontsize=16, pad=20)
        ax.set_xlabel('Land', fontsize=12)
        ax.set_ylabel('Anteil in Prozent (%)', fontsize=12)
        annotate_bars(ax)
        plt.tight_layout()
        plt.savefig(os.path.join(OUTPUT_DIR, '6_warnhinweise_land.png'))
        plt.close()
    else:
        print("   -> Keine Alkoholwerbung mit Warnhinweisen für die Visualisierung gefunden.")


if __name__ == '__main__':
    print("Starte Analyse der Supermarktprospekte...")
    
    # Schritt 1: Lade alle Daten-Subsets
    master_df = load_data(ANNOTATIONS_DIR)
    
    if master_df is not None:
        # Schritt 2: Bereinige und bereite die Daten vor
        processed_df = preprocess_data(master_df.copy())
        
        # Schritt 3: Führe Analysen durch und erstelle Diagramme
        generate_visual_report(processed_df)
        
        # Zusätzliche textbasierte Auswertungen
        print("\n--- Zusätzliche textbasierte Analysen ---")
        alc_on_cover = (processed_df[processed_df['page_number'] == 1]['alc'] == 1.0).mean() * 100
        print(f"Anteil der Titelseiten (Seite 1) mit Alkoholwerbung: {alc_on_cover:.2f}%")
        
        print("\nAnalyse abgeschlossen.")
        print(f"Ergebnisse und Diagramme wurden im Ordner '{OUTPUT_DIR}' gespeichert.")